let isScriptRunning = false;
let searchDirection = "forward";
let currentWeekIndex = 0;
let backwardWeekIndex = 0;
let weeksToSearch = 5;
let nextWeekDelay = 2000;
let isPopupVisible = false;
let foundSeat = false;
let retryCount = 0;
const maxRetries = 10;

function randomIntBetween(min, max) {
    return Math.floor(Math.random() * (max - min + 1) + min);
}

function randomDelay(callback) {
    const delay = randomIntBetween(3000, 6000);
    console.log(`Delaying for ${delay}ms before running callback`);
    setTimeout(callback, delay);
}

function showToast(message) {
    let toast = document.createElement("div");
    toast.className = "toast";
    toast.innerText = message;
    document.body.appendChild(toast);
    toast.classList.add("show");
    setTimeout(() => toast.remove(), 3000);
}

function checkForPopup() {
    const popup = document.querySelector('.ui-dialog.ui-corner-all.ui-widget.ui-widget-content.ui-front');
    if (popup) {
        const popupText = popup.textContent || popup.innerText;
        if (popupText.includes("Currently no tests are available")) {
            isPopupVisible = false;
            return false;
        }
        const isVisible = window.getComputedStyle(popup).display !== 'none' && window.getComputedStyle(popup).visibility !== 'hidden';
        if (isVisible) {
            console.log("Blocking popup detected. Pausing the script...");
            showToast("Blocking popup detected. Please dismiss it manually.");
            isPopupVisible = true;
            return true;
        }
    }
    if (isPopupVisible) {
        console.log("Popup dismissed, resuming script...");
        isPopupVisible = false;
        step6();
    }
    return false;
}

function step6() {
    if (!isScriptRunning) return;
    console.log(`Running Step 6 - Week ${searchDirection === "forward" ? currentWeekIndex + 1 : backwardWeekIndex + 1}/${weeksToSearch}, Direction: ${searchDirection}`);
    const dateElement = document.querySelector('.date-selector, .slotsavailable');
    if (!dateElement) {
        console.log("Date element not found");
        return;
    }
    const [dateText, month, year] = dateElement.innerText.split(' ');
    const parsedDate = new Date(`${dateText} ${month} ${year}`);
    console.log(`Parsed date: ${parsedDate}`);
    step7();
}

function step7() {
    if (!isScriptRunning) return;
    console.log(`Running Step 7 - Direction: ${searchDirection}, Retry: ${retryCount}`);
    const nextWeekLink = document.querySelector('#searchForWeeklySlotsNextWeek');
    if (nextWeekLink && !foundSeat) {
        console.log("Next week button found, attempting click...");
        setTimeout(() => {
            if (checkForPopup()) return;
            nextWeekLink.click();
            console.log("Clicked on next week link");
            showToast("Checking availability for next week...");
            setTimeout(step6, 8000);
        }, nextWeekDelay);
    } else {
        console.log("Next week button not found or seat found, retrying...");
        if (retryCount < maxRetries) {
            retryCount++;
            setTimeout(step7, 2000);
        } else {
            console.log("Max retries reached. Stopping search.");
            showToast("Max retries reached.");
        }
    }
}

function startSearch() {
    isScriptRunning = true;
    console.log("Starting the search script...");
    step6();
}

window.addEventListener('DOMContentLoaded', () => {
    console.log("DOM Loaded, waiting before script starts...");
    setTimeout(() => {
        console.log("Starting script...");
        startSearch();
    }, randomIntBetween(5000, 10000));
});
